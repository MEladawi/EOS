;							          _____                   _______                   _____          
;							         /\    \                 /::\    \                 /\    \         
;							        /::\    \               /::::\    \               /::\    \        
;							       /::::\    \             /::::::\    \             /::::\    \       
;							      /::::::\    \           /::::::::\    \           /::::::\    \      
;							     /:::/\:::\    \         /:::/~~\:::\    \         /:::/\:::\    \     
;							    /:::/__\:::\    \       /:::/    \:::\    \       /:::/__\:::\    \    
;							   /::::\   \:::\    \     /:::/    / \:::\    \      \:::\   \:::\    \   
;							  /::::::\   \:::\    \   /:::/____/   \:::\____\   ___\:::\   \:::\    \  
;							 /:::/\:::\   \:::\    \ |:::|    |     |:::|    | /\   \:::\   \:::\    \ 
;							/:::/__\:::\   \:::\____\|:::|____|     |:::|    |/::\   \:::\   \:::\____\
;							\:::\   \:::\   \::/    / \:::\    \   /:::/    / \:::\   \:::\   \::/    /
;							 \:::\   \:::\   \/____/   \:::\    \ /:::/    /   \:::\   \:::\   \/____/ 
;							  \:::\   \:::\    \        \:::\    /:::/    /     \:::\   \:::\    \     
;							   \:::\   \:::\____\        \:::\__/:::/    /       \:::\   \:::\____\    
;							    \:::\   \::/    /         \::::::::/    /         \:::\  /:::/    /    
;							     \:::\   \/____/           \::::::/    /           \:::\/:::/    /     
;							      \:::\    \                \::::/    /             \::::::/    /      
;							       \:::\____\                \::/____/               \::::/    /       
;							        \::/    /                 ~~                      \::/    /        
;							         \/____/  '11 Grad project                         \/____/         
;							                                                                           








.model tiny
.386P
.code
org 0h

;Definitions::::::::::::::::::::::::::::::::::::::::::::::::
KernelSize = 5
PMode_KernelBase = 10000h
Pmode_KernelStack = 100000h
RMode_KernelBase = 9000h
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;


GO proc;Jumb over inluded code!
	jp main
	RET
GO ENDP


;Include;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
include ..\LIB\GDT.inc
include ..\LIB\A20.inc
include ..\LIB\Print16.inc
include ..\LIB\Load16.inc
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;


main PROC
	sti
	mov ax, 7e0h
	mov ds, ax
;*****************************************************************Begin Pmode establishment***********************************************************************

;Load kernel temp. to 9000h
	mov cx, KernelSize
	mov Ax, 2h
	mov Bx, RMode_KernelBase
	call Load



;1-establish GDT:--------------------------------------
	cli
	call SetGDT
;--------------------------------------------------------------



;2-Enable A20:-------------------------------------------------
	call EnableA20
;-------------------------------------------------------------------



;3-Change CR0 (PE) bit to 1:--------------------------
	smsw	dx
	OR	dx, 1h
	lmsw	dx
;-------------------------------------------------------------------



;Make far jump manually ; ) -----------------------------
	push 8h  				;Cs: selector
	push ((offset done)+7e00h)	;offset
	retf
;-----------------------------------------------------------------------



;*********************************************************32-bit part :D :D :D*****************************************************
done: 
	mov ax, 10h ;offset of data segment is 
	mov ds, ax
	mov es, ax
	mov ss, ax
	mov ds, ax
	
	
	mov ecx, (kernelsize * 512 /4)
	mov esi, RMode_KernelBase
	mov edi, PMode_KernelBase
	Rep movsd
	
	
	hlt
	
	RET
main ENDP

;Data-----------------------------------------------------------------------------------------
LdMsg             Byte     "Loading operating system initializer", 0
DoneMsg         Byte     " [Done]",0Dh, 0Ah, 0
NewLineMsg    Byte      0Dh, 0Ah, 0 
FailMsg           Byte      "oops! fatal error occured in loading operating system initializer",0Dh, 0Ah, 0
RebootMsg     Byte       "press any key to reboot", 0Dh, 0Ah, 0 
WaitMsg          Byte      ".",0

;--------------------------------------------------------------------------------------------------------



End